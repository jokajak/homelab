apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
    name: nginx-external
    namespace: networking
spec:
    interval: 30m
    chart:
        spec:
            chart: ingress-nginx
            version: 4.7.1
            sourceRef:
                kind: HelmRepository
                name: ingress-nginx
                namespace: flux-system
    maxHistory: 2
    install:
        remediation:
            retries: 3
    upgrade:
        cleanupOnFail: true
        remediation:
            retries: 3
    uninstall:
        keepHistory: false
    values:
        fullnameOverride: nginx-external
        controller:
            replicaCount: 1
            service:
                annotations:
                    external-dns.alpha.kubernetes.io/hostname: external.${SECRET_DOMAIN}
                    io.cilium/lb-ipam-ips: ENC[AES256_GCM,data:zD1liXSbkcRsWxQY2Gc=,iv:/RF+ct4s83XjuRzo9uN4GJ2+LdcLR3uAIOguQNuRebo=,tag:EywDrCDMiN2wGiDTYE75EQ==,type:str]
                externalTrafficPolicy: Cluster
                ipFamilyPolicy: RequireDualStack
            ingressClassResource:
                name: external
                default: false
                controllerValue: k8s.io/external
            admissionWebhooks:
                objectSelector:
                    matchExpressions:
                        - key: ingress-class
                          operator: In
                          values:
                            - external
            config:
                client-body-buffer-size: 100M
                client-body-timeout: 120
                client-header-timeout: 120
                enable-brotli: "true"
                enable-real-ip: "true"
                hsts-max-age: 31449600
                keep-alive-requests: 10000
                keep-alive: 120
                log-format-escape-json: "true"
                log-format-upstream: |
                    {"time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for", "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": $request_length, "duration": $request_time, "method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent"}
                proxy-body-size: 0
                proxy-buffer-size: 16k
                ssl-protocols: TLSv1.3 TLSv1.2
            metrics:
                enabled: true
                serviceMonitor:
                    enabled: true
                    namespace: networking
                    namespaceSelector:
                        any: true
            extraArgs:
                default-ssl-certificate: networking/${SECRET_DOMAIN/./-}-staging-tls
            topologySpreadConstraints:
                - maxSkew: 1
                  topologyKey: kubernetes.io/hostname
                  whenUnsatisfiable: DoNotSchedule
                  labelSelector:
                    matchLabels:
                        app.kubernetes.io/name: nginx-external
                        app.kubernetes.io/component: controller
            resources:
                requests:
                    cpu: 10m
                    memory: 250Mi
                limits:
                    memory: 500Mi
        defaultBackend:
            enabled: false
sops:
    kms: []
    gcp_kms: []
    azure_kv: []
    hc_vault: []
    age:
        - recipient: age1pr4mejfd5gvq7fvkhgs534dftetx83564rj4j2y0hat6eucjl49qp60ag5
          enc: |
            -----BEGIN AGE ENCRYPTED FILE-----
            YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IFgyNTUxOSBhTVZZelFON0czUHlsWHpi
            NjlqY2h3cjJ5U05DUjQxUE5zYSs3WkdBUURBCnNYWnpyOEtGS2YxVEhnL0lWcFlG
            eW96Q1pKZC9MWWJ2ZGZicmR0OFF4YlUKLS0tIFh0dTVJdlhRTEhtRkRBdTRXRm5n
            dHo3VGc1aVRVREVXVExMV3ZMcFJ1NGMKNno6X+5hjsx/Ayqg72/hAPkpSbuVUvfh
            UgNYGzVrk6E6MTTLILTQ6mtcJp8tGGwHkc+L6OdCRPPG3ME0/Llsqw==
            -----END AGE ENCRYPTED FILE-----
    lastmodified: "2023-10-04T21:38:14Z"
    mac: ENC[AES256_GCM,data:LDb+gQoKMv5/eX9k3OPxsRHDoDYOqFT+u62e5E89VPJDp7EfMYbnKM/54LZV6aXfKU1/1CjyWM/H0Y5wgO7D4KKPvkvJhJjuSuuiLg4BfqWV6Ooa8Vbt5WY/jMU0NeUjVihh17XGsFZgJia+HSCBLX3NEADFlVRhcKHiOBZJWv8=,iv:m2WMJVNCZLroZbQJY/4/Kh5c77xBBI6S1I3QA0L1koc=,tag:Pj3ukLJ+yki8zrBJZ17IFQ==,type:str]
    pgp: []
    encrypted_regex: lb-ipam-ips
    version: 3.8.0
